<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸°ê³„ ì§„ë™ ë¶„ì„ê¸°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .controls {
            text-align: center;
            margin-bottom: 30px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .stop-btn {
            background: #f44336;
        }
        .calibrate-btn {
            background: #ff9800;
        }
        .status {
            text-align: center;
            font-size: 18px;
            margin: 20px 0;
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
        }
        .charts {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        .chart-container {
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: 15px;
            height: 300px;
        }
        .diagnosis {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .normal { background: rgba(76, 175, 80, 0.8); }
        .warning { background: rgba(255, 193, 7, 0.8); }
        .danger { background: rgba(244, 67, 54, 0.8); }
        .data-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .data-card {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .data-value {
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
        }
        .calibration-info {
            background: rgba(255, 152, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; margin-bottom: 30px;">ğŸ”§ ê¸°ê³„ ì§„ë™ ë¶„ì„ê¸°</h1>
        
        <div class="controls">
            <button id="startBtn" onclick="requestPermission()">ì„¼ì„œ ê¶Œí•œ ìš”ì²­</button>
            <button id="calibrateBtn" onclick="calibrateSensor()" class="calibrate-btn" disabled>ì¤‘ë ¥ ë³´ì •</button>
            
            <div style="margin: 15px 0;">
                <label for="applianceSelect" style="display: block; margin-bottom: 5px;">ì¸¡ì •í•  ê°€ì „ì œí’ˆ:</label>
                <select id="applianceSelect" style="padding: 8px; border-radius: 5px; margin-right: 10px;">
                    <option value="general">ì¼ë°˜ ê¸°ê³„</option>
                    <option value="washer">ì„¸íƒê¸°</option>
                    <option value="refrigerator">ëƒ‰ì¥ê³ </option>
                    <option value="airconditioner">ì—ì–´ì»¨</option>
                    <option value="fan">ì„ í’ê¸°</option>
                    <option value="dishwasher">ì‹ê¸°ì„¸ì²™ê¸°</option>
                    <option value="microwave">ì „ìë ˆì¸ì§€</option>
                </select>
                <select id="modeSelect" style="padding: 8px; border-radius: 5px;">
                    <option value="normal">ì¼ë°˜ ì‘ë™</option>
                </select>
            </div>
            
            <button id="measureBtn" onclick="startMeasurement()" disabled>ì¸¡ì • ì‹œì‘</button>
            <button id="stopBtn" onclick="stopMeasurement()" class="stop-btn" disabled>ì¸¡ì • ì¤‘ì§€</button>
        </div>

        <div id="status" class="status">ì„¼ì„œ ê¶Œí•œì„ ë¨¼ì € ìš”ì²­í•´ì£¼ì„¸ìš”</div>

        <div id="calibrationInfo" class="calibration-info" style="display: none;">
            ğŸ“± ì¤‘ë ¥ ë³´ì • ì¤‘... í•¸ë“œí°ì„ í‰í‰í•œ ê³³ì— ë†“ê³  ì›€ì§ì´ì§€ ë§ˆì„¸ìš”
        </div>

        <div id="diagnosis" class="diagnosis normal" style="display: none;">
            ì§„ë‹¨ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
        </div>

        <div class="data-info" id="dataInfo" style="display: none;">
            <div class="data-card">
                <div>RMS ì§„ë™</div>
                <div class="data-value" id="rmsValue">0.00</div>
                <div>m/sÂ²</div>
            </div>
            <div class="data-card">
                <div>ìµœëŒ€ ì§„ë™</div>
                <div class="data-value" id="maxValue">0.00</div>
                <div>m/sÂ²</div>
            </div>
            <div class="data-card">
                <div>ë³´ì • ìƒíƒœ</div>
                <div class="data-value" id="calibrationStatus">ë¯¸ë³´ì •</div>
                <div></div>
            </div>
            <div class="data-card">
                <div>ì¸¡ì • ì‹œê°„</div>
                <div class="data-value" id="measureTime">0</div>
                <div>ì´ˆ</div>
            </div>
        </div>
    </div>

    <div class="container charts">
        <div class="chart-container">
            <canvas id="timeChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="frequencyChart"></canvas>
        </div>
    </div>

    <script>
        let isPermissionGranted = false;
        let isMeasuring = false;
        let isCalibrated = false;
        let vibrationData = [];
        let startTime = 0;
        let measurementInterval;
        let timeChart, frequencyChart;

        // ì¤‘ë ¥ ë³´ì • ë³€ìˆ˜
        let gravityX = 0, gravityY = 0, gravityZ = 0;
        let calibrationSamples = [];
        let calibrationTimer = null;

        // ê°€ì „ì œí’ˆë³„ ì§„ë‹¨ ê¸°ì¤€
        const applianceStandards = {
            general: {
                normal: { normal: 1.5, warning: 3.0 }
            },
            washer: {
                wash: { normal: 1.5, warning: 3.0 },
                rinse: { normal: 1.2, warning: 2.5 },
                spin: { normal: 4.0, warning: 6.0 }
            },
            refrigerator: {
                compressor_off: { normal: 0.3, warning: 0.6 },
                compressor_on: { normal: 1.0, warning: 2.0 },
                fan_running: { normal: 0.8, warning: 1.5 }
            },
            airconditioner: {
                standby: { normal: 0.4, warning: 0.8 },
                compressor: { normal: 1.5, warning: 3.0 },
                fan_max: { normal: 2.0, warning: 3.5 }
            },
            fan: {
                low: { normal: 0.8, warning: 1.5 },
                medium: { normal: 1.2, warning: 2.2 },
                high: { normal: 1.8, warning: 3.0 }
            },
            dishwasher: {
                wash: { normal: 2.0, warning: 3.5 },
                drain: { normal: 2.5, warning: 4.0 },
                dry: { normal: 1.0, warning: 2.0 }
            },
            microwave: {
                standby: { normal: 0.2, warning: 0.4 },
                heating: { normal: 0.8, warning: 1.5 },
                turbo_fan: { normal: 1.0, warning: 2.0 }
            }
        };

        // ë²„íŠ¼ ë° ìƒíƒœ ìš”ì†Œ
        const startBtn = document.getElementById('startBtn');
        const calibrateBtn = document.getElementById('calibrateBtn');
        const measureBtn = document.getElementById('measureBtn');
        const stopBtn = document.getElementById('stopBtn');
        const status = document.getElementById('status');
        const diagnosis = document.getElementById('diagnosis');
        const dataInfo = document.getElementById('dataInfo');
        const calibrationInfo = document.getElementById('calibrationInfo');

        // ê°€ì „ì œí’ˆ ì„ íƒ ì´ë²¤íŠ¸
        document.getElementById('applianceSelect').addEventListener('change', updateModeOptions);

        // ëª¨ë“œ ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updateModeOptions() {
            const appliance = document.getElementById('applianceSelect').value;
            const modeSelect = document.getElementById('modeSelect');
            
            const modeOptions = {
                general: [['normal', 'ì¼ë°˜ ì‘ë™']],
                washer: [['wash', 'ì„¸íƒ'], ['rinse', 'í—¹êµ¼'], ['spin', 'íƒˆìˆ˜']],
                refrigerator: [['compressor_off', 'ì••ì¶•ê¸° OFF'], ['compressor_on', 'ì••ì¶•ê¸° ON'], ['fan_running', 'íŒ¬ ê°€ë™']],
                airconditioner: [['standby', 'ëŒ€ê¸°ëª¨ë“œ'], ['compressor', 'ì••ì¶•ê¸° ê°€ë™'], ['fan_max', 'íŒ¬ ìµœëŒ€ì†ë„']],
                fan: [['low', 'ì•½í’ (1ë‹¨)'], ['medium', 'ì¤‘í’ (2ë‹¨)'], ['high', 'ê°•í’ (3ë‹¨)']],
                dishwasher: [['wash', 'ì„¸ì²™'], ['drain', 'ë°°ìˆ˜'], ['dry', 'ê±´ì¡°']],
                microwave: [['standby', 'ëŒ€ê¸°'], ['heating', 'ê°€ì—´ì¤‘'], ['turbo_fan', 'í„°ë³´íŒ¬']]
            };

            modeSelect.innerHTML = '';
            const options = modeOptions[appliance] || [['normal', 'ì¼ë°˜ ì‘ë™']];
            
            options.forEach(([value, text]) => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                modeSelect.appendChild(option);
            });
        }

        // ì„¼ì„œ ê¶Œí•œ ìš”ì²­
        async function requestPermission() {
            try {
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    // iOS 13+
                    const permission = await DeviceMotionEvent.requestPermission();
                    if (permission === 'granted') {
                        isPermissionGranted = true;
                        status.textContent = 'âœ… ì„¼ì„œ ê¶Œí•œ í—ˆìš©ë¨! ë¨¼ì € ì¤‘ë ¥ ë³´ì •ì„ í•´ì£¼ì„¸ìš”.';
                        startBtn.disabled = true;
                        calibrateBtn.disabled = false;
                        initCharts();
                    } else {
                        status.textContent = 'âŒ ì„¼ì„œ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    }
                } else {
                    // Android ë˜ëŠ” ì´ì „ iOS
                    isPermissionGranted = true;
                    status.textContent = 'âœ… ì„¼ì„œ ì‚¬ìš© ê°€ëŠ¥! ë¨¼ì € ì¤‘ë ¥ ë³´ì •ì„ í•´ì£¼ì„¸ìš”.';
                    startBtn.disabled = true;
                    calibrateBtn.disabled = false;
                    initCharts();
                }
            } catch (error) {
                status.textContent = 'âŒ ì˜¤ë¥˜: ' + error.message;
            }
        }

        // ì¤‘ë ¥ ë³´ì • (ì¤‘ìš”!)
        function calibrateSensor() {
            if (!isPermissionGranted) {
                alert('ë¨¼ì € ì„¼ì„œ ê¶Œí•œì„ ìš”ì²­í•´ì£¼ì„¸ìš”!');
                return;
            }

            calibrationInfo.style.display = 'block';
            calibrateBtn.disabled = true;
            calibrationSamples = [];
            
            status.textContent = 'ğŸ”„ ì¤‘ë ¥ ë³´ì • ì¤‘... (3ì´ˆê°„ í•¸ë“œí°ì„ ì›€ì§ì´ì§€ ë§ˆì„¸ìš”)';

            // 3ì´ˆê°„ ì¤‘ë ¥ ê°’ ìˆ˜ì§‘
            window.addEventListener('devicemotion', collectCalibrationData);
            
            calibrationTimer = setTimeout(() => {
                window.removeEventListener('devicemotion', collectCalibrationData);
                finishCalibration();
            }, 3000);
        }

        // ë³´ì •ìš© ë°ì´í„° ìˆ˜ì§‘
        function collectCalibrationData(event) {
            const accelX = event.accelerationIncludingGravity?.x || 0;
            const accelY = event.accelerationIncludingGravity?.y || 0;
            const accelZ = event.accelerationIncludingGravity?.z || 0;

            calibrationSamples.push({ x: accelX, y: accelY, z: accelZ });
        }

        // ë³´ì • ì™„ë£Œ
        function finishCalibration() {
            if (calibrationSamples.length > 0) {
                // í‰ê· ê°’ìœ¼ë¡œ ì¤‘ë ¥ ë²¡í„° ê³„ì‚°
                gravityX = calibrationSamples.reduce((sum, sample) => sum + sample.x, 0) / calibrationSamples.length;
                gravityY = calibrationSamples.reduce((sum, sample) => sum + sample.y, 0) / calibrationSamples.length;
                gravityZ = calibrationSamples.reduce((sum, sample) => sum + sample.z, 0) / calibrationSamples.length;

                isCalibrated = true;
                calibrationInfo.style.display = 'none';
                status.textContent = 'âœ… ì¤‘ë ¥ ë³´ì • ì™„ë£Œ! ì´ì œ ì¸¡ì •ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                measureBtn.disabled = false;
                document.getElementById('calibrationStatus').textContent = 'ì™„ë£Œ';
            } else {
                status.textContent = 'âŒ ë³´ì • ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                calibrateBtn.disabled = false;
                calibrationInfo.style.display = 'none';
            }
        }

        // ì°¨íŠ¸ ì´ˆê¸°í™”
        function initCharts() {
            // ì‹œê°„-ì§„ë™ ì°¨íŠ¸
            const timeCtx = document.getElementById('timeChart').getContext('2d');
            timeChart = new Chart(timeCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ìˆœìˆ˜ ì§„ë™ (ì¤‘ë ¥ ë³´ì •ë¨) m/sÂ²',
                        data: [],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'ì‹œê°„ (ì´ˆ)' }},
                        y: { 
                            title: { display: true, text: 'ê°€ì†ë„ (m/sÂ²)' },
                            min: 0,
                            max: 10
                        }
                    },
                    plugins: {
                        title: { display: true, text: 'ì‹¤ì‹œê°„ ì§„ë™ íŒŒí˜• (ì¤‘ë ¥ ì œê±°ë¨)' }
                    }
                }
            });

            // ì£¼íŒŒìˆ˜ ìŠ¤í™íŠ¸ëŸ¼ ì°¨íŠ¸
            const freqCtx = document.getElementById('frequencyChart').getContext('2d');
            frequencyChart = new Chart(freqCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ì§„ë™ ê°•ë„',
                        data: [],
                        backgroundColor: '#FF6384',
                        borderColor: '#FF6384'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'ì£¼íŒŒìˆ˜ (Hz)' }},
                        y: { title: { display: true, text: 'ê°•ë„' }}
                    },
                    plugins: {
                        title: { display: true, text: 'ì£¼íŒŒìˆ˜ ìŠ¤í™íŠ¸ëŸ¼ (FFT)' }
                    }
                }
            });
        }

        // ì¸¡ì • ì‹œì‘
        function startMeasurement() {
            if (!isPermissionGranted) {
                alert('ë¨¼ì € ì„¼ì„œ ê¶Œí•œì„ ìš”ì²­í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (!isCalibrated) {
                alert('ë¨¼ì € ì¤‘ë ¥ ë³´ì •ì„ í•´ì£¼ì„¸ìš”!');
                return;
            }

            isMeasuring = true;
            vibrationData = [];
            startTime = Date.now();

            measureBtn.disabled = true;
            stopBtn.disabled = false;
            status.textContent = 'ğŸ“Š ì§„ë™ ì¸¡ì • ì¤‘... í•¸ë“œí°ì„ ì¸¡ì •í•˜ë ¤ëŠ” ê¸°ê³„ì— ì˜¬ë ¤ì£¼ì„¸ìš”';
            diagnosis.style.display = 'block';
            dataInfo.style.display = 'grid';

            // ì„¼ì„œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            window.addEventListener('devicemotion', handleMotionEvent);

            // 1ì´ˆë§ˆë‹¤ ë¶„ì„ ì—…ë°ì´íŠ¸
            measurementInterval = setInterval(updateAnalysis, 1000);
        }

        // ì¸¡ì • ì¤‘ì§€
        function stopMeasurement() {
            isMeasuring = false;
            
            measureBtn.disabled = false;
            stopBtn.disabled = true;
            status.textContent = `âœ… ì¸¡ì • ì™„ë£Œ! ì´ ${vibrationData.length}ê°œ ë°ì´í„° ìˆ˜ì§‘ë¨`;

            // ì„¼ì„œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            window.removeEventListener('devicemotion', handleMotionEvent);
            clearInterval(measurementInterval);

            // ìµœì¢… ë¶„ì„ ì‹¤í–‰
            performFinalAnalysis();
        }

        // ì„¼ì„œ ë°ì´í„° ì²˜ë¦¬ (ì¤‘ë ¥ ë³´ì • ì ìš©)
        function handleMotionEvent(event) {
            if (!isMeasuring || !isCalibrated) return;

            const timestamp = (Date.now() - startTime) / 1000; // ì´ˆ ë‹¨ìœ„
            
            // ì›ì‹œ ê°€ì†ë„ ë°ì´í„°
            const rawX = event.accelerationIncludingGravity?.x || 0;
            const rawY = event.accelerationIncludingGravity?.y || 0;
            const rawZ = event.accelerationIncludingGravity?.z || 0;

            // ì¤‘ë ¥ ë³´ì •ëœ ìˆœìˆ˜ ì§„ë™ ê³„ì‚°
            const vibX = rawX - gravityX;
            const vibY = rawY - gravityY;
            const vibZ = rawZ - gravityZ;

            // ì´ ì§„ë™ í¬ê¸° ê³„ì‚° (ì¤‘ë ¥ ì œê±°ë¨)
            const totalVibration = Math.sqrt(vibX*vibX + vibY*vibY + vibZ*vibZ);

            vibrationData.push({
                time: timestamp,
                x: vibX,
                y: vibY,
                z: vibZ,
                total: totalVibration
            });

            // ì°¨íŠ¸ ì—…ë°ì´íŠ¸ (ìµœê·¼ 100ê°œ ë°ì´í„°ë§Œ)
            updateTimeChart();
        }

        // ì‹œê°„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateTimeChart() {
            const recentData = vibrationData.slice(-100); // ìµœê·¼ 100ê°œ
            
            timeChart.data.labels = recentData.map(d => d.time.toFixed(1));
            timeChart.data.datasets[0].data = recentData.map(d => d.total);
            timeChart.update('none'); // ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ë¹ ë¥¸ ì—…ë°ì´íŠ¸
        }

        // ì‹¤ì‹œê°„ ë¶„ì„ ì—…ë°ì´íŠ¸
        function updateAnalysis() {
            if (vibrationData.length < 10) return;

            const recentData = vibrationData.slice(-50); // ìµœê·¼ 50ê°œ ë°ì´í„°
            const values = recentData.map(d => d.total);

            // RMS ê³„ì‚°
            const rms = Math.sqrt(values.reduce((sum, val) => sum + val*val, 0) / values.length);
            const maxVal = Math.max(...values);
            const measureTime = ((Date.now() - startTime) / 1000).toFixed(1);

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('rmsValue').textContent = rms.toFixed(3);
            document.getElementById('maxValue').textContent = maxVal.toFixed(3);
            document.getElementById('measureTime').textContent = measureTime;

            // ì§„ë‹¨ (ì¤‘ë ¥ ë³´ì •ëœ ê¸°ì¤€ê°’)
            updateDiagnosis(rms, maxVal);

            // FFT ë¶„ì„ (ê°„ë‹¨ ë²„ì „)
            if (values.length >= 32) {
                updateFrequencyChart(values);
            }
        }

        // ì§„ë‹¨ ì—…ë°ì´íŠ¸ (ê°€ì „ì œí’ˆë³„ ê¸°ì¤€ ì ìš©)
        function updateDiagnosis(rms, maxVal) {
            const appliance = document.getElementById('applianceSelect').value;
            const mode = document.getElementById('modeSelect').value;
            
            const standard = applianceStandards[appliance]?.[mode];
            if (!standard) {
                // ê¸°ë³¸ ê¸°ì¤€ ì‚¬ìš©
                diagnosisBasic(rms, maxVal);
                return;
            }

            let diagnosisText = '';
            let className = '';
            
            const applianceNames = {
                general: 'ê¸°ê³„',
                washer: 'ì„¸íƒê¸°',
                refrigerator: 'ëƒ‰ì¥ê³ ',
                airconditioner: 'ì—ì–´ì»¨',
                fan: 'ì„ í’ê¸°',
                dishwasher: 'ì‹ê¸°ì„¸ì²™ê¸°',
                microwave: 'ì „ìë ˆì¸ì§€'
            };

            const modeNames = {
                normal: 'ì¼ë°˜ ì‘ë™',
                wash: 'ì„¸íƒ', rinse: 'í—¹êµ¼', spin: 'íƒˆìˆ˜',
                compressor_off: 'ì••ì¶•ê¸° OFF', compressor_on: 'ì••ì¶•ê¸° ON', fan_running: 'íŒ¬ ê°€ë™',
                standby: 'ëŒ€ê¸°ëª¨ë“œ', compressor: 'ì••ì¶•ê¸° ê°€ë™', fan_max: 'íŒ¬ ìµœëŒ€ì†ë„',
                low: 'ì•½í’', medium: 'ì¤‘í’', high: 'ê°•í’',
                drain: 'ë°°ìˆ˜', dry: 'ê±´ì¡°',
                heating: 'ê°€ì—´ì¤‘', turbo_fan: 'í„°ë³´íŒ¬'
            };

            const applianceName = applianceNames[appliance] || 'ê¸°ê³„';
            const modeName = modeNames[mode] || 'ì‘ë™';

            if (rms <= standard.normal) {
                diagnosisText = `âœ… ì •ìƒ: ${applianceName} ${modeName} ëª¨ë“œê°€ ì •ìƒ ë²”ìœ„ì…ë‹ˆë‹¤ (${rms.toFixed(2)} m/sÂ²)`;
                className = 'normal';
            } else if (rms <= standard.warning) {
                diagnosisText = `âš ï¸ ì£¼ì˜: ${applianceName}ì—ì„œ ì•½ê°„ ë†’ì€ ì§„ë™ì´ ê°ì§€ë©ë‹ˆë‹¤. ì ê²€ì„ ê¶Œì¥í•©ë‹ˆë‹¤ (${rms.toFixed(2)} m/sÂ²)`;
                className = 'warning';
            } else {
                diagnosisText = `ğŸš¨ ìœ„í—˜: ${applianceName}ì—ì„œ ê³¼ë„í•œ ì§„ë™ ê°ì§€! ${getDangerAdvice(appliance, mode)} (${rms.toFixed(2)} m/sÂ²)`;
                className = 'danger';
            }

            diagnosis.textContent = diagnosisText;
            diagnosis.className = `diagnosis ${className}`;
        }

        // ìœ„í—˜ ìƒí™©ë³„ ì¡°ì¹˜ ì‚¬í•­
        function getDangerAdvice(appliance, mode) {
            const advice = {
                washer: {
                    wash: 'ëª¨í„° ë² ì–´ë§ ì ê²€ í•„ìš”',
                    rinse: 'ë°°ìˆ˜ ì‹œìŠ¤í…œ ì ê²€ í•„ìš”', 
                    spin: 'ì„¸íƒë¬¼ ë¶ˆê· í˜• ë˜ëŠ” ì¶• ë§ˆëª¨ ì˜ì‹¬'
                },
                refrigerator: {
                    compressor_off: 'ì„¤ì¹˜ ìƒíƒœ ì ê²€ í•„ìš”',
                    compressor_on: 'ì••ì¶•ê¸° ë§ˆìš´íŠ¸ ë¶ˆëŸ‰ ë˜ëŠ” ëƒ‰ë§¤ ë¶€ì¡± ì˜ì‹¬',
                    fan_running: 'íŒ¬ ë² ì–´ë§ ë§ˆëª¨ ì˜ì‹¬'
                },
                airconditioner: {
                    standby: 'ì„¤ì¹˜ ë¶ˆëŸ‰ ì ê²€ í•„ìš”',
                    compressor: 'ì••ì¶•ê¸° ë¶ˆê· í˜• ë˜ëŠ” ì„¤ì¹˜ ë¶ˆëŸ‰',
                    fan_max: 'íŒ¬ ë¸”ë ˆì´ë“œ ì†ìƒ ë˜ëŠ” ë² ì–´ë§ ë§ˆëª¨'
                },
                fan: {
                    low: 'ë‚ ê°œ ë¶ˆê· í˜• ë˜ëŠ” ëª¨í„° ë² ì–´ë§ ë§ˆëª¨',
                    medium: 'ë‚ ê°œ ë¶ˆê· í˜• ë˜ëŠ” ëª¨í„° ë² ì–´ë§ ë§ˆëª¨',
                    high: 'ë‚ ê°œ ë¶ˆê· í˜• ë˜ëŠ” ëª¨í„° ë² ì–´ë§ ë§ˆëª¨'
                },
                dishwasher: {
                    wash: 'ì›Œì‹œ íŒí”„ ì ê²€ í•„ìš”',
                    drain: 'ë°°ìˆ˜ íŒí”„ ê³¼ë¶€í•˜ ì˜ì‹¬',
                    dry: 'ê±´ì¡°íŒ¬ ë² ì–´ë§ ë§ˆëª¨'
                },
                microwave: {
                    standby: 'ë‚´ë¶€ ë¶€í’ˆ ì ê²€ í•„ìš”',
                    heating: 'ë§ˆê·¸ë„¤íŠ¸ë¡  ë¶ˆëŸ‰ ì˜ì‹¬',
                    turbo_fan: 'ëƒ‰ê°íŒ¬ ë² ì–´ë§ ë§ˆëª¨'
                }
            };

            return advice[appliance]?.[mode] || 'ì¦‰ì‹œ ì „ë¬¸ê°€ ì ê²€ í•„ìš”';
        }

        // ê¸°ë³¸ ì§„ë‹¨ (ì´ì „ ë°©ì‹)
        function diagnosisBasic(rms, maxVal) {
            let diagnosisText = '';
            let className = '';

            if (rms < 0.5 && maxVal < 2.0) {
                diagnosisText = 'âœ… ìš°ìˆ˜: ë§¤ìš° ë‚®ì€ ì§„ë™ ìˆ˜ì¤€';
                className = 'normal';
            } else if (rms < 1.5 && maxVal < 4.0) {
                diagnosisText = 'âœ… ì–‘í˜¸: ì •ìƒ ë²”ìœ„ì˜ ì§„ë™';
                className = 'normal';
            } else if (rms < 3.0 && maxVal < 8.0) {
                diagnosisText = 'âš ï¸ ì£¼ì˜: ì•½ê°„ ë†’ì€ ì§„ë™ ê°ì§€';
                className = 'warning';
            } else if (rms < 5.0 && maxVal < 15.0) {
                diagnosisText = 'âš ï¸ ê²½ê³ : ë†’ì€ ì§„ë™ ìˆ˜ì¤€';
                className = 'warning';
            } else {
                diagnosisText = 'ğŸš¨ ìœ„í—˜: ê³¼ë„í•œ ì§„ë™! ì ê²€ í•„ìš”';
                className = 'danger';
            }

            diagnosis.textContent = diagnosisText;
            diagnosis.className = `diagnosis ${className}`;
        }

        // ì£¼íŒŒìˆ˜ ì°¨íŠ¸ ì—…ë°ì´íŠ¸ (ê°„ë‹¨í•œ FFT)
        function updateFrequencyChart(data) {
            // ê°„ë‹¨í•œ ì£¼íŒŒìˆ˜ ë¶„ì„ (ì‹¤ì œ FFTëŠ” ë³µì¡í•˜ë¯€ë¡œ ê·¼ì‚¬ì¹˜)
            const freqBands = [
                { name: '0-2Hz', sum: 0 },
                { name: '2-5Hz', sum: 0 },
                { name: '5-10Hz', sum: 0 },
                { name: '10-20Hz', sum: 0 },
                { name: '20Hz+', sum: 0 }
            ];

            // ê°„ë‹¨í•œ ì§„ë™ ê°•ë„ ë¶„ì„
            for (let i = 0; i < data.length; i++) {
                const val = Math.abs(data[i]);
                if (i % 16 === 0) freqBands[0].sum += val;
                else if (i % 10 === 0) freqBands[1].sum += val;
                else if (i % 6 === 0) freqBands[2].sum += val;
                else if (i % 3 === 0) freqBands[3].sum += val;
                else freqBands[4].sum += val;
            }

            const labels = freqBands.map(band => band.name);
            const values = freqBands.map(band => band.sum / 5);

            frequencyChart.data.labels = labels;
            frequencyChart.data.datasets[0].data = values;
            frequencyChart.update('none');
        }

        // ìµœì¢… ë¶„ì„
        function performFinalAnalysis() {
            if (vibrationData.length < 10) return;

            const values = vibrationData.map(d => d.total);
            const rms = Math.sqrt(values.reduce((sum, val) => sum + val*val, 0) / values.length);
            
            let finalDiagnosis = '';
            if (rms < 0.3) {
                finalDiagnosis = 'ğŸ‰ ì™„ë²½: ê±°ì˜ ì§„ë™ì´ ì—†ìŠµë‹ˆë‹¤';
            } else if (rms < 1.0) {
                finalDiagnosis = 'âœ… ìš°ìˆ˜: ë§¤ìš° ì–‘í˜¸í•œ ìƒíƒœ';
            } else if (rms < 2.5) {
                finalDiagnosis = 'âœ… ì–‘í˜¸: ì •ìƒ ë²”ìœ„ ë‚´ ì§„ë™';
            } else if (rms < 4.0) {
                finalDiagnosis = 'âš ï¸ ì£¼ì˜: ì ê²€ì„ ê¶Œì¥í•©ë‹ˆë‹¤';
            } else {
                finalDiagnosis = 'ğŸš¨ ìœ„í—˜: ì¦‰ì‹œ ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤';
            }

            diagnosis.textContent = finalDiagnosis;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•ˆë‚´
        window.addEventListener('load', function() {
            status.textContent = 'ğŸ“± ìŠ¤ë§ˆíŠ¸í° ê¸°ë°˜ ê¸°ê³„ ì§„ë™ ë¶„ì„ê¸°ì…ë‹ˆë‹¤. ì„¼ì„œ ê¶Œí•œì„ ë¨¼ì € ìš”ì²­í•´ì£¼ì„¸ìš”.';
            updateModeOptions(); // ì´ˆê¸° ëª¨ë“œ ì˜µì…˜ ì„¤ì •
        });
    </script>
</body>
</html>
