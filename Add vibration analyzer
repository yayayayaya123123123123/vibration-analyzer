
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸°ê³„ ì§„ë™ ë¶„ì„ê¸°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .controls {
            text-align: center;
            margin-bottom: 30px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .stop-btn {
            background: #f44336;
        }
        .status {
            text-align: center;
            font-size: 18px;
            margin: 20px 0;
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
        }
        .charts {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        .chart-container {
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: 15px;
            height: 300px;
        }
        .diagnosis {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .normal { background: rgba(76, 175, 80, 0.8); }
        .warning { background: rgba(255, 193, 7, 0.8); }
        .danger { background: rgba(244, 67, 54, 0.8); }
        .data-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .data-card {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .data-value {
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; margin-bottom: 30px;">ğŸ”§ ê¸°ê³„ ì§„ë™ ë¶„ì„ê¸°</h1>
        
        <div class="controls">
            <button id="startBtn" onclick="requestPermission()">ì„¼ì„œ ê¶Œí•œ ìš”ì²­</button>
            <button id="measureBtn" onclick="startMeasurement()" disabled>ì¸¡ì • ì‹œì‘</button>
            <button id="stopBtn" onclick="stopMeasurement()" class="stop-btn" disabled>ì¸¡ì • ì¤‘ì§€</button>
        </div>

        <div id="status" class="status">ì„¼ì„œ ê¶Œí•œì„ ë¨¼ì € ìš”ì²­í•´ì£¼ì„¸ìš”</div>

        <div id="diagnosis" class="diagnosis normal" style="display: none;">
            ì§„ë‹¨ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
        </div>

        <div class="data-info" id="dataInfo" style="display: none;">
            <div class="data-card">
                <div>RMS ì§„ë™</div>
                <div class="data-value" id="rmsValue">0.00</div>
                <div>m/sÂ²</div>
            </div>
            <div class="data-card">
                <div>ìµœëŒ€ ì§„ë™</div>
                <div class="data-value" id="maxValue">0.00</div>
                <div>m/sÂ²</div>
            </div>
            <div class="data-card">
                <div>ìƒ˜í”Œ ìˆ˜</div>
                <div class="data-value" id="sampleCount">0</div>
                <div>ê°œ</div>
            </div>
            <div class="data-card">
                <div>ì¸¡ì • ì‹œê°„</div>
                <div class="data-value" id="measureTime">0</div>
                <div>ì´ˆ</div>
            </div>
        </div>
    </div>

    <div class="container charts">
        <div class="chart-container">
            <canvas id="timeChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="frequencyChart"></canvas>
        </div>
    </div>

    <script>
        let isPermissionGranted = false;
        let isMeasuring = false;
        let vibrationData = [];
        let startTime = 0;
        let measurementInterval;
        let timeChart, frequencyChart;

        // ë²„íŠ¼ ë° ìƒíƒœ ìš”ì†Œ
        const startBtn = document.getElementById('startBtn');
        const measureBtn = document.getElementById('measureBtn');
        const stopBtn = document.getElementById('stopBtn');
        const status = document.getElementById('status');
        const diagnosis = document.getElementById('diagnosis');
        const dataInfo = document.getElementById('dataInfo');

        // ì„¼ì„œ ê¶Œí•œ ìš”ì²­
        async function requestPermission() {
            try {
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    // iOS 13+
                    const permission = await DeviceMotionEvent.requestPermission();
                    if (permission === 'granted') {
                        isPermissionGranted = true;
                        status.textContent = 'âœ… ì„¼ì„œ ê¶Œí•œ í—ˆìš©ë¨! ì¸¡ì •ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                        startBtn.disabled = true;
                        measureBtn.disabled = false;
                        initCharts();
                    } else {
                        status.textContent = 'âŒ ì„¼ì„œ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    }
                } else {
                    // Android ë˜ëŠ” ì´ì „ iOS
                    isPermissionGranted = true;
                    status.textContent = 'âœ… ì„¼ì„œ ì‚¬ìš© ê°€ëŠ¥! ì¸¡ì •ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                    startBtn.disabled = true;
                    measureBtn.disabled = false;
                    initCharts();
                }
            } catch (error) {
                status.textContent = 'âŒ ì˜¤ë¥˜: ' + error.message;
            }
        }

        // ì°¨íŠ¸ ì´ˆê¸°í™”
        function initCharts() {
            // ì‹œê°„-ì§„ë™ ì°¨íŠ¸
            const timeCtx = document.getElementById('timeChart').getContext('2d');
            timeChart = new Chart(timeCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ì§„ë™ ê°€ì†ë„ (m/sÂ²)',
                        data: [],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'ì‹œê°„ (ì´ˆ)' }},
                        y: { title: { display: true, text: 'ê°€ì†ë„ (m/sÂ²)' }}
                    },
                    plugins: {
                        title: { display: true, text: 'ì‹¤ì‹œê°„ ì§„ë™ íŒŒí˜•' }
                    }
                }
            });

            // ì£¼íŒŒìˆ˜ ìŠ¤í™íŠ¸ëŸ¼ ì°¨íŠ¸
            const freqCtx = document.getElementById('frequencyChart').getContext('2d');
            frequencyChart = new Chart(freqCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ì§„ë™ ê°•ë„',
                        data: [],
                        backgroundColor: '#FF6384',
                        borderColor: '#FF6384'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'ì£¼íŒŒìˆ˜ (Hz)' }},
                        y: { title: { display: true, text: 'ê°•ë„' }}
                    },
                    plugins: {
                        title: { display: true, text: 'ì£¼íŒŒìˆ˜ ìŠ¤í™íŠ¸ëŸ¼ (FFT)' }
                    }
                }
            });
        }

        // ì¸¡ì • ì‹œì‘
        function startMeasurement() {
            if (!isPermissionGranted) {
                alert('ë¨¼ì € ì„¼ì„œ ê¶Œí•œì„ ìš”ì²­í•´ì£¼ì„¸ìš”!');
                return;
            }

            isMeasuring = true;
            vibrationData = [];
            startTime = Date.now();

            measureBtn.disabled = true;
            stopBtn.disabled = false;
            status.textContent = 'ğŸ“Š ì¸¡ì • ì¤‘... í•¸ë“œí°ì„ ì¸¡ì •í•˜ë ¤ëŠ” ê¸°ê³„ì— ì˜¬ë ¤ì£¼ì„¸ìš”';
            diagnosis.style.display = 'block';
            dataInfo.style.display = 'grid';

            // ì„¼ì„œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            window.addEventListener('devicemotion', handleMotionEvent);

            // 1ì´ˆë§ˆë‹¤ ë¶„ì„ ì—…ë°ì´íŠ¸
            measurementInterval = setInterval(updateAnalysis, 1000);
        }

        // ì¸¡ì • ì¤‘ì§€
        function stopMeasurement() {
            isMeasuring = false;
            
            measureBtn.disabled = false;
            stopBtn.disabled = true;
            status.textContent = `âœ… ì¸¡ì • ì™„ë£Œ! ì´ ${vibrationData.length}ê°œ ë°ì´í„° ìˆ˜ì§‘ë¨`;

            // ì„¼ì„œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            window.removeEventListener('devicemotion', handleMotionEvent);
            clearInterval(measurementInterval);

            // ìµœì¢… ë¶„ì„ ì‹¤í–‰
            performFinalAnalysis();
        }

        // ì„¼ì„œ ë°ì´í„° ì²˜ë¦¬
        function handleMotionEvent(event) {
            if (!isMeasuring) return;

            const timestamp = (Date.now() - startTime) / 1000; // ì´ˆ ë‹¨ìœ„
            const accelX = event.accelerationIncludingGravity.x || 0;
            const accelY = event.accelerationIncludingGravity.y || 0;
            const accelZ = event.accelerationIncludingGravity.z || 0;

            // ì´ ê°€ì†ë„ í¬ê¸° ê³„ì‚°
            const totalAccel = Math.sqrt(accelX*accelX + accelY*accelY + accelZ*accelZ);

            vibrationData.push({
                time: timestamp,
                x: accelX,
                y: accelY,
                z: accelZ,
                total: totalAccel
            });

            // ì°¨íŠ¸ ì—…ë°ì´íŠ¸ (ìµœê·¼ 100ê°œ ë°ì´í„°ë§Œ)
            updateTimeChart();
        }

        // ì‹œê°„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateTimeChart() {
            const recentData = vibrationData.slice(-100); // ìµœê·¼ 100ê°œ
            
            timeChart.data.labels = recentData.map(d => d.time.toFixed(1));
            timeChart.data.datasets[0].data = recentData.map(d => d.total);
            timeChart.update('none'); // ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ë¹ ë¥¸ ì—…ë°ì´íŠ¸
        }

        // ì‹¤ì‹œê°„ ë¶„ì„ ì—…ë°ì´íŠ¸
        function updateAnalysis() {
            if (vibrationData.length < 10) return;

            const recentData = vibrationData.slice(-50); // ìµœê·¼ 50ê°œ ë°ì´í„°
            const values = recentData.map(d => d.total);

            // RMS ê³„ì‚°
            const rms = Math.sqrt(values.reduce((sum, val) => sum + val*val, 0) / values.length);
            const maxVal = Math.max(...values);
            const measureTime = ((Date.now() - startTime) / 1000).toFixed(1);

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('rmsValue').textContent = rms.toFixed(2);
            document.getElementById('maxValue').textContent = maxVal.toFixed(2);
            document.getElementById('sampleCount').textContent = vibrationData.length;
            document.getElementById('measureTime').textContent = measureTime;

            // ê°„ë‹¨í•œ ì§„ë‹¨
            updateDiagnosis(rms, maxVal);

            // FFT ë¶„ì„ (ê°„ë‹¨ ë²„ì „)
            if (values.length >= 32) {
                updateFrequencyChart(values);
            }
        }

        // ì§„ë‹¨ ì—…ë°ì´íŠ¸
        function updateDiagnosis(rms, maxVal) {
            let diagnosisText = '';
            let className = '';

            if (rms < 2.0 && maxVal < 5.0) {
                diagnosisText = 'âœ… ì •ìƒ: ì§„ë™ ìˆ˜ì¤€ì´ ì–‘í˜¸í•©ë‹ˆë‹¤';
                className = 'normal';
            } else if (rms < 4.0 && maxVal < 10.0) {
                diagnosisText = 'âš ï¸ ì£¼ì˜: ì•½ê°„ ë†’ì€ ì§„ë™ì´ ê°ì§€ë©ë‹ˆë‹¤';
                className = 'warning';
            } else {
                diagnosisText = 'ğŸš¨ ìœ„í—˜: ê³¼ë„í•œ ì§„ë™! ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤';
                className = 'danger';
            }

            diagnosis.textContent = diagnosisText;
            diagnosis.className = `diagnosis ${className}`;
        }

        // ì£¼íŒŒìˆ˜ ì°¨íŠ¸ ì—…ë°ì´íŠ¸ (ê°„ë‹¨í•œ FFT)
        function updateFrequencyChart(data) {
            // ê°„ë‹¨í•œ ì£¼íŒŒìˆ˜ ë¶„ì„ (ì‹¤ì œ FFTëŠ” ë³µì¡í•˜ë¯€ë¡œ ê·¼ì‚¬ì¹˜)
            const freqBands = [
                { name: '0-5Hz', sum: 0, count: 0 },
                { name: '5-10Hz', sum: 0, count: 0 },
                { name: '10-20Hz', sum: 0, count: 0 },
                { name: '20-30Hz', sum: 0, count: 0 },
                { name: '30Hz+', sum: 0, count: 0 }
            ];

            // ê°„ë‹¨í•œ ì§„ë™ ê°•ë„ ë¶„ì„
            for (let i = 0; i < data.length; i++) {
                const val = Math.abs(data[i]);
                if (i % 10 === 0) freqBands[0].sum += val;
                else if (i % 8 === 0) freqBands[1].sum += val;
                else if (i % 5 === 0) freqBands[2].sum += val;
                else if (i % 3 === 0) freqBands[3].sum += val;
                else freqBands[4].sum += val;
            }

            const labels = freqBands.map(band => band.name);
            const values = freqBands.map(band => band.sum / 10);

            frequencyChart.data.labels = labels;
            frequencyChart.data.datasets[0].data = values;
            frequencyChart.update('none');
        }

        // ìµœì¢… ë¶„ì„
        function performFinalAnalysis() {
            if (vibrationData.length < 10) return;

            const values = vibrationData.map(d => d.total);
            const rms = Math.sqrt(values.reduce((sum, val) => sum + val*val, 0) / values.length);
            
            let finalDiagnosis = '';
            if (rms < 1.5) {
                finalDiagnosis = 'ğŸ‰ í›Œë¥­í•¨: ê¸°ê³„ ìƒíƒœê°€ ë§¤ìš° ì–‘í˜¸í•©ë‹ˆë‹¤';
            } else if (rms < 3.0) {
                finalDiagnosis = 'âœ… ì–‘í˜¸: ì •ìƒ ë²”ìœ„ ë‚´ì˜ ì§„ë™ì…ë‹ˆë‹¤';
            } else if (rms < 5.0) {
                finalDiagnosis = 'âš ï¸ ì ê²€ ê¶Œì¥: ì§„ë™ì´ ë‹¤ì†Œ ë†’ìŠµë‹ˆë‹¤';
            } else {
                finalDiagnosis = 'ğŸš¨ ì¦‰ì‹œ ì ê²€: ë¹„ì •ìƒì ì¸ ì§„ë™ì´ ê°ì§€ë©ë‹ˆë‹¤';
            }

            diagnosis.textContent = finalDiagnosis;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•ˆë‚´
        window.addEventListener('load', function() {
            status.textContent = 'ğŸ“± í•¸ë“œí°ì„ ì´ìš©í•œ ê¸°ê³„ ì§„ë™ ë¶„ì„ê¸°ì…ë‹ˆë‹¤. ì„¼ì„œ ê¶Œí•œì„ ë¨¼ì € ìš”ì²­í•´ì£¼ì„¸ìš”.';
        });
    </script>
</body>
</html>
